---
title：iOS离屏渲染
tags: [ios, ]
---

要想理解离屏渲染，首先要知道iOS的渲染过程：

#### 正常的渲染过程：

CPU计算->GPU着色、格栅化产生bitmap->存放于buff->显示器显示。

#### 离屏渲染

由于无法一次性形成图片，不得不开辟空间做一次离屏操作(剪切，阴影等效果)，称为离屏渲染。

- 离屏渲染过程：CPU计算->GPU着色、格栅化产生bitmap->存放于framebuff->转移到buff->显示器显示

正常情况下，每一帧图片生成后，会被缓存在buff中，显示器每16.67ms会去buff中获取图片展示，形成我们肉眼可见的动画画面。

#### 卡顿的形成：

由于画面绘制超时，显示器在16.67ms后无法拿到最新的画面，仍旧显示之前的一帧，就会形成我们肉眼可察觉的画面卡顿。

#### 渲染原理：

图片的渲染过程，类似于我们日常画画，由远到近，依次绘制每一层layer内容，最后绘制的画面会遮盖之前的画面，最后形成最终画面。

如果有一层Layer设置了`cornerRadius`和`maskToBounds`，然后在其上面又有新的内容添加上去，为了能裁切到最后的画面内容，所有的layer都会被暂时存储起来，等待最后做统一的裁切处理

#### 离屏渲染的条件：

- 同时设置`cornerRadius`和`maskToBounds`，目前iOS13.3`UIImageView`需要设置`backgroundColor`或者`border`时才会触发
- 设置`shadow`

